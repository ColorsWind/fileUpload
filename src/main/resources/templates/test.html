<!DOCTYPE html>
<!--suppress ALL-->
<html xmlns:th="http://www.thymeleaf.org">
<head>

    <title>用户页面</title>
    <div th:insert="base :: static_files"/>
    <div th:insert="base :: layui"/>

</head>
<body>

<div th:insert="~{base :: navbar}"/>


<!-- 第一页 -->

<div class="container">
    <div class="row">

        <!--主题-->
        <div class="col-md-9">
            <div class="headfontsize" id="one">
                <h1 class="headh1content" th:text="${session.user.getName()} + ',的项目列表'">
                    hello,你要新建一个项目吗?
                </h1>
                <p class="btn-app-stroe">
                    <a class="btn btn-success btn-lg" href="/createWork">立即创建,开始收集</a>
                </p>
            </div>


            <div id="two">
                <div class="panel panel-success">
                    <div class="panel-heading">正在进行中的项目</div>
                    <div class="panel-body">
                        <table class="layui-hide" id="doing" lay-filter="test"></table>

                        <!--顶部工具栏-->
                        <script type="text/html" id="toolbarDemo">
                            <div class="layui-btn-container">
                                <button class="layui-btn layui-btn-sm" lay-event="download">打包下载</button>
                            </div>
                        </script>

                        <!--行工具栏-->
                        <script type="text/html" id="barDemo">
                            <a class="layui-btn layui-btn-success layui-btn-xs" lay-event="show">查看</a>
                            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
                        </script>

                        <!-- 是否加密 -->
                        <script type="text/html" id="switchTpl">
                            <input type="checkbox" name="encryption" value="{{d.id}}" lay-skin="switch" lay-text="是|否" lay-filter="switchDemo" {{ d.encryption == 0 ? '' : 'checked' }}>
                        </script>

                    </div>

                </div>
            </div>


        </div>



        <!--侧边栏-->
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">用户空间使用量</div>
                <div class="panel-body">
                    <div id="main" class="container" style="width: 300px;height: 150px;"></div>
                    <div class="container">
                        <p> 用户文件夹空间总量: <strong id="total">0</strong> M </p>
                        <p> 用户文件夹空间已用: <strong id="used">0</strong> M </p>
                        <p> 用户文件夹空间剩余: <strong id="free">0</strong> M </p>
                        <button class="btn-sm btn-primary">点击查看详情</button>
                        <button class="btn-sm btn-success">点击购买容量</button>
                    </div>
                </div>
            </div>



<!--            <div class="panel panel-default">-->
<!--                <div class="panel-heading">用户留言信息：</div>-->


<!--                    <div class="layui-collapse" lay-filter="test" th:if="${#arrays.length(remarks)} != 0" th:each="remark : ${remarks}">-->
<!--                        <div class="layui-colla-item">-->
<!--                            <h2 class="layui-colla-title" th:text="${remark.name} + ' - ' + ${remark.createTime}">为什么前端工程师多不愿意用 Bootstrap 框架？</h2>-->
<!--                            <div class="layui-colla-content">-->
<!--                                <p th:text="${remark.remark}">因为不适合。如果希望开发长期的项目或者制作产品类网站，那么就需要实现特定的设计，为了在维护项目中可以方便地按设计师要求快速修改样式，肯定会逐步编写出各种业务组件、工具类，相当于为项目自行开发一套框架。——来自知乎@Kayo</p>-->
<!--                                <a th:href="'mailto:' + ${remark.email}"><button type="button" class="layui-btn layui-btn-fluid layui-btn-xs">回复 <i class="layui-icon layui-icon-reply-fill"></i></button></a>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                <div class="panel-body" th:unless="${#arrays.length(remarks)} != 0">-->
<!--                    <span class="text-center">暂无留言！</span>-->
<!--                </div>-->
            </div>




    </div>

</div>





<script type="text/javascript">

    function initEcahrst() {
        // 绘制图表。
        var myChart = echarts.init(document.getElementById('main'));
        myChart.showLoading();
        var dataList = [];
        // 获取数据
        $.ajax({
            url: '/spaceUsage',
            type: "get",
            contentType:  "application/x-www-form-urlencoded", //"application/json", 内容编码类型，默认
            dataType: "json", // 预期服务器返回数据格式
            timeout: 3000, // 超时时间，60s
            data: {"userid": [[${session.user.getId()}]] }, // 请求参数
            success: function(data){
                console.info(data);
                if(data.code == 200){
                    var total = data.data.total;
                    var used = data.data.used;
                    $("#total").html(total.toFixed(2))
                    $("#used").html(used.toFixed(2))
                    $("#free").html((total - used).toFixed(2))
                    dataList.push({value: used, name:'已用'},
                        {value: total - used, name:'可用'})
                }
                myChart.hideLoading();
                myChart.setOption({
                    tooltip: {
                        trigger: 'item',
                        formatter: "{a} <br/>{b}: {c} ({d}%)"
                    },
                    legend: {
                        orient: 'vertical',
                        x: 'left',
                    },
                    series: [
                        {
                            name:'用户空间使用情况',
                            type:'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: false,
                            label: {
                                normal: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    show: true,
                                    textStyle: {
                                        fontSize: '30',
                                        fontWeight: 'bold'
                                    }
                                }
                            },
                            labelLine: {
                                normal: {
                                    show: false
                                }
                            },
                            data:dataList
                        }
                    ]
                });
                dataList = [];
            }
        });
    }
    initEcahrst();

    function changeEncryption(data){
        $.ajax({
            url: '/changeEncryption',
            type: "post",
            async: true, // 是否异步请求（此处需这只为异步请求true，否则bootstrap的modal不会顺序显示）
            cache: false, // 是否缓存此页面，每次都请求服务器
            contentType: "application/x-www-form-urlencoded", // 内容编码类型，默认
            dataType: "json", // 预期服务器返回数据格式
            timeout: 3000, // 超时时间，60s
            data: data, // 请求参数
            // 请求成功预处理，返回的值为success的参数data
            success: function(data){
                if(data.code === 200){
                    layer.msg(data.info, {time: 5000, icon:6});
                    self.location.href="/userpage";
                }else{
                    layer.msg(data.info, {time: 5000, icon:2});
                }
                $("#captcha-img").click();  // 刷新验证码
                console.info(JSON.stringify(data));
            },
            error: function(xhr, errMsg, e){
                $("#captcha-img").click();  // 刷新验证码
                layer.msg(errMsg, {time: 5000, icon:2});
            }
        });
    }

    // 修改
    function changeHomeWork(data){
        $.ajax({
            url: '/user/homework',
            type: "put",
            async: true, // 是否异步请求（此处需这只为异步请求true，否则bootstrap的modal不会顺序显示）
            cache: false, // 是否缓存此页面，每次都请求服务器
            contentType: "application/json", //"application/x-www-form-urlencoded", // 内容编码类型，默认
            dataType: "json", // 预期服务器返回数据格式
            timeout: 3000, // 超时时间，60s
            data: JSON.stringify(data), // 请求参数
            success: function(data){
                if(data.code === 200){
                    layer.msg(data.info, {time: 5000, icon:6});
                }else{
                    layer.msg(data.info, {time: 5000, icon:5});
                }
            },
            error: function(xhr, errMsg, e){
                layer.msg(errMsg, {time: 5000, icon:2});
            }
        });
    }

    // 删除作业
    function deleteHomeWork(data){
        $.ajax({
            url: '/user/homework',
            type: "delete",
            async: true, // 是否异步请求（此处需这只为异步请求true，否则bootstrap的modal不会顺序显示）
            cache: false, // 是否缓存此页面，每次都请求服务器
            contentType: "application/json", //"application/x-www-form-urlencoded", // 内容编码类型，默认
            dataType: "json", // 预期服务器返回数据格式
            timeout: 3000, // 超时时间，60s
            data: JSON.stringify(data), // 请求参数
            success: function(data){
                if(data.code === 200){
                    layer.msg(data.info, {time: 5000, icon:6});
                }else{
                    layer.msg(data.info, {time: 5000, icon:5});
                }
            },
            error: function(xhr, errMsg, e){
                console.info(JSON.stringify(data));
                layer.msg(errMsg, {time: 5000, icon:2});
            }
        });
    }


    // 留言板
    layui.use(['element', 'layer'], function(){
        var element = layui.element;
        var layer = layui.layer;
    });


    // 加载表
    layui.use(['table', 'form'], function() {
        var table = layui.table;
        var form = layui.form;
        // 加载表
        table.render({
            elem: '#doing'
            , url: '/user/doingHomeWork'
            , id: 'doingId'
            , where: {
                userid: [[${session.user.getId()}]],
            }
            , title: '正在进行中的项目'
            , cols: [
                [
                    , {field: 'title', title: '项目名', edit: 'text'}
                    , {field: 'createtime', title: '创建时间', sort: true}
                    , {field: 'endtime', title: '截止时间', sort: true}
                    , {field: 'total', title: '文件数量', edit: 'text'}
                    , {field: 'invitationCode', title: '邀请码'}
                    , {field: 'encryption', title: '是否加密',templet: '#switchTpl', unresize: true}
                    , {fixed: 'right', align: 'center', toolbar: '#barDemo'} //这里的toolbar值是模板元素的选择器
                ]
            ]
            , page: true
        });


        //监听行工具事件
        table.on('tool(doing)', function (obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data //获得当前行数据
                , layEvent = obj.event; //获得 lay-event 对应的值
            console.info(data);
            if (layEvent === 'del') {
                layer.confirm('真的删除行吗？', function (index) {
                    obj.del(); //删除对应行（tr）的DOM结构
                    layer.close(index);
                    //向服务端发送删除指令
                    deleteHomeWork(data);
                    table.reload('doingId', {
                        where: {
                            page: 1,
                            pageSize: 10
                        }
                    }); //只重载数据
                });
            }else {
                layer.msg("跳转项目页面");
            }
        });

        //监听加密切换操作
        form.on('switch(switchDemo)', function(obj){
            layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
            changeEncryption({'id':this.value});
        });

        //监听单元格编辑
        table.on('edit(doing)', function (obj) {
            var value = obj.value //得到修改后的值
                , data = obj.data //得到所在行所有键值
                , field = obj.field; //得到字段

            layer.confirm('真的修改行吗？', {
                btn: ['是', '否'] //按钮
            }, function () {
                layer.msg('[ID: ' + data.id + '] ' + field + ' 字段更改为：' + value);
                changeHomeWork(data);
            }, function () {
                table.reload('doingId', {
                    where: {
                    }
                }); //只重载数据
            });

        })
    });


</script>

</body>


<footer th:insert="~{base :: footer}" class="navbar-fixed-bottom"/>

</html>

